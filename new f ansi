for i in biweb cloud-connector iserver library kafka redis mobile search-service; do
  echo "---- $i ----"
  oc get all -n matr-env | grep -i $i
done


What youâ€™re asking for is exactly how **real production automation** should be designed:

> **playbook never changes â†’ only variables change.**

Below is a **production-grade, generic, audit-ready Ansible design** for restarting **MicroStrategy Library + IServer** (or any future MSTR components) on OpenShift.

---

# ðŸ”¹ Architecture (Generic & Production Style)

```
mstr-restart/
â”œâ”€â”€ playbook.yml        # never change
â”œâ”€â”€ vars.yml            # only this changes
â”œâ”€â”€ logs/
â”‚   â”œâ”€â”€ mstr-restart.log
â”‚   â””â”€â”€ archive/
â””â”€â”€ roles/
    â””â”€â”€ mstr_restart/
        â”œâ”€â”€ tasks/
        â”‚   â”œâ”€â”€ login.yml
        â”‚   â”œâ”€â”€ discover.yml
        â”‚   â”œâ”€â”€ status.yml
        â”‚   â”œâ”€â”€ restart.yml
        â”‚   â”œâ”€â”€ wait.yml
        â”‚   â”œâ”€â”€ validate.yml
        â”‚   â””â”€â”€ logging.yml
```

---

# ðŸ”¹ vars.yml (ONLY file you change)

```yaml
ocp_api: https://api.ocp.example.com:6443
namespace: matr-env

# Auto discovery filters
mstr_components:
  - name: library
    selector: library
  - name: iserver
    selector: iserver

log_dir: "./logs"
max_logs: 5
```

---

# ðŸ”¹ playbook.yml (NEVER TOUCH AGAIN)

```yaml
- name: MicroStrategy Generic Restart Automation
  hosts: localhost
  gather_facts: no
  vars_files:
    - vars.yml

  vars_prompt:
    - name: ocp_user
      prompt: "Enter OCP Username"
      private: no
    - name: ocp_pass
      prompt: "Enter OCP Password"
      private: yes

  pre_tasks:
    - name: Timestamp
      set_fact:
        run_ts: "{{ lookup('pipe','date +%Y%m%d_%H%M%S') }}"

    - name: Create log dirs
      file:
        path: "{{ item }}"
        state: directory
      loop:
        - "{{ log_dir }}"
        - "{{ log_dir }}/archive"

  roles:
    - mstr_restart
```

---

# ðŸ”¹ roles/mstr_restart/tasks/login.yml

```yaml
- name: Login to OpenShift
  shell: |
    oc login {{ ocp_api }} -u {{ ocp_user }} -p {{ ocp_pass }} --insecure-skip-tls-verify
  register: login_out
  failed_when: "'Login successful' not in login_out.stdout"
```

---

# ðŸ”¹ discover.yml (Auto detect Deployments/StatefulSets/Pods)

```yaml
- name: Discover MSTR resources
  shell: |
    oc get all -n {{ namespace }} | egrep -i "{{ item.selector }}"
  loop: "{{ mstr_components }}"
  register: discovered
```

---

# ðŸ”¹ status.yml (BEFORE)

```yaml
- name: BEFORE status
  shell: oc get pods -n {{ namespace }}
  register: before_status

- debug: var=before_status.stdout
```

---

# ðŸ”¹ restart.yml (Works for ANY type)

```yaml
- name: Restart discovered resources
  shell: |
    if echo "{{ item.stdout }}" | grep -q deployment; then
      oc rollout restart deployment $(echo "{{ item.stdout }}" | awk '{print $1}') -n {{ namespace }}
    elif echo "{{ item.stdout }}" | grep -q statefulset; then
      oc rollout restart statefulset $(echo "{{ item.stdout }}" | awk '{print $1}') -n {{ namespace }}
    else
      oc delete pod $(echo "{{ item.stdout }}" | awk '{print $1}') -n {{ namespace }}
    fi
  loop: "{{ discovered.results }}"
```

---

# ðŸ”¹ wait.yml

```yaml
- name: Wait until all pods ready
  shell: |
    oc wait --for=condition=Ready pod --all -n {{ namespace }} --timeout=600s
```

---

# ðŸ”¹ validate.yml (FAIL on bad states)

```yaml
- name: Validate pod health
  shell: |
    oc get pods -n {{ namespace }} | egrep -i "CrashLoop|Error|ImagePull"
  register: badpods
  failed_when: badpods.stdout != ""
```

---

# ðŸ”¹ status.yml (AFTER)

```yaml
- name: AFTER status
  shell: oc get pods -n {{ namespace }}
  register: after_status

- debug: var=after_status.stdout
```

---

# ðŸ”¹ logging.yml (Audit + rotation)

```yaml
- name: Write log
  copy:
    content: |
      USER={{ ocp_user }}
      TIME={{ run_ts }}
      BEFORE:
      {{ before_status.stdout }}

      AFTER:
      {{ after_status.stdout }}
    dest: "{{ log_dir }}/mstr-restart-{{ run_ts }}.log"

- name: Rotate logs
  shell: |
    ls -t {{ log_dir }}/mstr-restart-*.log | tail -n +{{ max_logs + 1 }} | xargs rm -f
```

---

# ðŸ”¹ What this gives you (Production Quality)

| Feature           | Yes |
| ----------------- | --- |
| Secure login      | âœ”   |
| Auto discovery    | âœ”   |
| Any K8s object    | âœ”   |
| Before / After    | âœ”   |
| Health gate       | âœ”   |
| Fail on errors    | âœ”   |
| Audit + logs      | âœ”   |
| Rotation          | âœ”   |
| No playbook edits | âœ”   |

---

# ðŸ”¹ How you run

```bash
ansible-playbook playbook.yml
```

---

If you want next, I can:
ðŸ‘‰ Add **email alerts**
ðŸ‘‰ Add **Slack/Teams webhook**
ðŸ‘‰ Add **dry-run mode**
ðŸ‘‰ Convert to **Tower / AAP job template**
